name: Discussion Triage & Moderation

on:
  discussion:
    types: [created, labeled]
  discussion_comment:
    types: [created]

permissions:
  discussions: write
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Bug Report Triage
        if: contains(github.event.discussion.category.name, 'Bug')
        uses: actions/github-script@v7
        with:
          script: |
            const discussion = context.payload.discussion;
            const body = discussion.body || '';
            
            const hasChain = /chain|network|ethereum|polygon|arbitrum|optimism/i.test(body);
            const hasSteps = /steps|reproduce|how to/i.test(body);
            const hasExpected = /expected|should|supposed to/i.test(body);
            
            const missing = [];
            if (!hasChain) missing.push('blockchain/network');
            if (!hasSteps) missing.push('steps to reproduce');
            if (!hasExpected) missing.push('expected behavior');
            
            if (missing.length > 0) {
              const checklist = missing.map(function(m) { return '- [ ] ' + m; }).join('\n');
              
              const helpLines = [
                '## ðŸ“‹ Additional Information Needed',
                '',
                'Thanks for reporting this issue! To help us investigate faster, please provide:',
                '',
                checklist,
                '',
                '**Template:**',
                '```',
                'Chain/Network: ',
                'Steps to reproduce:',
                '1. ',
                '2. ',
                '3. ',
                'Expected behavior:',
                'Actual behavior:',
                'Transaction hash (if applicable):',
                '```'
              ];
              
              const helpMessage = helpLines.join('\n');

              const mutation = [
                'mutation($discussionId: ID!, $body: String!) {',
                '  addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {',
                '    comment { id }',
                '  }',
                '}'
              ].join('\n');
              
              await github.graphql(mutation, {
                discussionId: discussion.node_id,
                body: helpMessage
              });
            }

      - name: Convert confirmed bug to issue
        if: contains(github.event.label.name, 'confirmed')
        uses: actions/github-script@v7
        with:
          script: |
            const discussion = context.payload.discussion;
            
            const issueBody = [
              '**Converted from Discussion #' + discussion.number + '**',
              '',
              discussion.body,
              '',
              '---',
              '*Original discussion: ' + discussion.html_url + '*',
              '*Reported by: @' + discussion.user.login + '*'
            ].join('\n');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[Bug] ' + discussion.title,
              body: issueBody,
              labels: ['bug']
            });

            const confirmMessage = [
              '## âœ… Bug Confirmed',
              '',
              'This has been converted to an issue for tracking: #' + issue.data.number,
              '',
              'We will continue updates there. Thanks for reporting!'
            ].join('\n');
            
            const mutation = [
              'mutation($discussionId: ID!, $body: String!) {',
              '  addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {',
              '    comment { id }',
              '  }',
              '}'
            ].join('\n');
            
            await github.graphql(mutation, {
              discussionId: discussion.node_id,
              body: confirmMessage
            });
