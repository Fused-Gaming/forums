name: Welcome New Discussion Authors

on:
  discussion:
    types: [created]

permissions:
  discussions: write

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - name: Check if first-time author
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.discussion.user.login;
            const repo = context.repo.owner + '/' + context.repo.repo;
            const { data: discussions } = await github.rest.search.issuesAndPullRequests({
              q: 'repo:' + repo + ' author:' + author + ' is:discussion',
            });
            return discussions.total_count <= 1;
          result-encoding: string

      - name: Welcome first-time author
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const category = context.payload.discussion.category.name;
            const username = context.payload.discussion.user.login;
            
            const welcomeLines = [
              '## ðŸ‘‹ Welcome to FUSED GAMING!',
              '',
              'Thanks for starting your first discussion here, @' + username + '!',
              '',
              '**Quick links:**',
              '- ðŸ“œ [Community Guidelines](../blob/main/CODE_OF_CONDUCT.md)',
              '- ðŸ“– [Wiki & Documentation](../wiki)',
              '- ðŸŽ® [Discord](https://discord.gg/fusedgaming)',
              ''
            ];

            if (category.includes('Q&A') || category.includes('Help')) {
              welcomeLines.push(
                '**Tips for getting help faster:**',
                '- Include relevant details (chain, wallet, transaction hash if applicable)',
                '- Share what you have already tried',
                '- Check if your question was already answered in past discussions',
                '',
                'Our community members typically respond within 24 hours.'
              );
            } else if (category.includes('Ideas') || category.includes('Feedback')) {
              welcomeLines.push(
                '**For feature requests:**',
                '- Describe the problem you are trying to solve',
                '- Explain how your idea would help',
                '- Upvote similar ideas to help us prioritize',
                '',
                'We review community feedback weekly!'
              );
            }

            const welcomeMessage = welcomeLines.join('\n');
            
            const mutation = [
              'mutation($discussionId: ID!, $body: String!) {',
              '  addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {',
              '    comment { id }',
              '  }',
              '}'
            ].join('\n');

            await github.graphql(mutation, {
              discussionId: context.payload.discussion.node_id,
              body: welcomeMessage
            });
