name: Sync Labels from Config

on:
  push:
    paths:
      - '.github/config/labels.json'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  sync-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync labels
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const configPath = '.github/config/labels.json';
            if (!fs.existsSync(configPath)) {
              console.log('No labels config found');
              return;
            }
            
            const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
            const labels = config.labels || [];
            
            // Get existing labels
            const existingLabels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const existingMap = {};
            for (var i = 0; i < existingLabels.data.length; i++) {
              existingMap[existingLabels.data[i].name] = existingLabels.data[i];
            }
            
            for (var j = 0; j < labels.length; j++) {
              var label = labels[j];
              var existing = existingMap[label.name];

              if (existing) {
                // Update if changed
                if (existing.description !== label.description || existing.color !== label.color) {
                  try {
                    await github.rest.issues.updateLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label.name,
                      description: label.description,
                      color: label.color
                    });
                    console.log('Updated label: ' + label.name);
                  } catch (e) {
                    console.log('Failed to update label ' + label.name + ': ' + e.message);
                  }
                }
              } else {
                // Create new label
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    description: label.description,
                    color: label.color
                  });
                  console.log('Created label: ' + label.name);
                } catch (e) {
                  console.log('Failed to create label ' + label.name + ': ' + e.message);
                }
              }
            }
            
            console.log('Label sync complete');
